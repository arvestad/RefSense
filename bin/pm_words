#! /usr/bin/perl -w

use lib "/home/compbio/arve/src/biblio/lib";
use PubMed;
use Citation;

my $DefaultDispMax = 100;
my $numdays = 0;
my $RefCount = 0;
my $method = 'uilist';

my %tag_translation= ('year' => 'DP',
		      'title' => 'TI',
		      'author' => 'AU',
		      'journal' => 'TA',
		      'abstract' => 'TIAB');

my $usage = "Usage: pmsearch [<options>] <search terms>+

Options:
   -u         This text.
   -c         Return the number of matching items.
   -d <int>   The maximum number of PMID:s to report. Default: $DefaultDispMax.
   -t <num days> The number of days from today to include in search.
";


if (@ARGV == 0) {
  print $usage, "\n";
}

my @searchterms=();

while (my $opt = shift @ARGV) {
  if ($opt eq '-u') {
    print $usage;
    exit 0;
  }

  if ($opt eq '-c') {
    $method = 'count';
  } elsif ($opt eq '-d') {
    if (@ARGV) {
      my $int = shift @ARGV;
      if ($int =~ /\d+/) {
	$DefaultDispMax = $int;
      } else {
	print STDERR "Argument to option '-d' must be an integer. Found '$int' instead.";
	print STDERR $usage;
	exit 1;
      }
    } else {
      print STDERR "An integer is expected as an argument to option '-d'.";
      print STDERR $usage;
      exit 2;
    }
  } elsif ($opt eq '-t') {
    if (@ARGV) {
      my $int = shift @ARGV;
      if ($int =~ /\d+/) {
	$numdays = $int;
      } else {
	print STDERR "Argument to option '-t' must be an integer. Found '$int' instead.";
	print STDERR $usage;
	exit 3;
      }
    } else {
      print STDERR "An integer is expected as an argument to option '-t'.";
      print STDERR $usage;
      exit 4;
    }
  } else {
    if ($opt =~ m/(\S+)=(\S+)/) {
      my $tag = $1;
      if (exists $tag_translation{$tag}) {
	$tag = $tag_translation{$tag};
      }
      push @searchterms, "$2\[$tag\]";
    } else {
      push @searchterms, $opt;
    }
  }
}

my $term = join('+AND+', @searchterms);
my $def_query = {'term' => $term,
		 'rettype' => $method};
if ($numdays > 0) {
  $def_query->{'reldate'} = $numdays;
}



my ($count, $pmids) = pm_query($def_query);

if ($method eq 'count') {
  print $count, "\n";
} else {
  foreach my $id (@$pmids) {
    print $id, "\n";
  }
}
