#! /usr/bin/perl -w

#use lib "$ENV{HOME}/lib/biblio";
use PubMed;
use Citation;
use Globals;

# Option flags:
my $show_abstract = 0;
my $sort_by_year = 0;

my $usage = "Usage: pmid2bibtex [<option>] [<pubmed identifier>+]

Options:
   -u, -h, --help
            This text.
   -y       Sort by year.
   -ay      BibTeX keys are composed as <1st author><year>, instead of
            <1st author><PMID>. Keys are no longer guaranteed to be unique.
   -w       Include PubMed's URL reference in the record.

If no PMID is given on the command line, STDIN is read until EOF
and parsed for PMID:s. The expected format is a PMID first on each
line, possibly followed by a space and any string.

See also home page at http://www.nada.kth.se/~arve/biblio.
";


my @pmids = ();

while (my $opt = shift @ARGV) {
  if ($opt eq '-u' || $opt eq '-h' || $opt eq '--help') {
    print $usage;
    exit 0;
  }

  if ($opt eq '-y') {
    $sort_by_year = 1;
  } elsif ($opt eq '-ay') {
    $BibTeXKeysAsAuthorYear = 1;
  } elsif ($opt eq '-w') {
    $IncludeURLInBibTeX = 1;
  } elsif ($opt =~ m/\d+/) {
    push @pmids, $opt;
  } else {
    print STDERR "Cannot use command line argument: '$opt'\n";
    exit 1;
  }
}

if (scalar(@pmids) == 0) {
  while (<>) {
    if (/^(\s*[+-]?\s*)(\d+)/) {
      if (length($1) < 5) {
	push @pmids, $2;
      }
    }
  }
}

if (scalar(@pmids) == 0) {
  print STDERR "No PubMed identifiers.\n";
  exit(0);
}

my $art_h = pm_fetch_pubmed(\@pmids);
foreach my $id (keys %$art_h) {
  print make_bibtex_citation($art_h->{$id});
}
