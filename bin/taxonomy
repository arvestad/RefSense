#! /usr/bin/perl -w

=pod

=head1 NAME

taxonomy - Access NCBI's taxonomy resource

=head1 SYNOPSIS

    taxonomy [<options>] <search terms>+

=head2 OPTIONS

-u, -h, and --help returns this text!

=head1 DESCRIPTION

=head2 Search Terms

Scientific of common name.

=cut


use PubMed;
use Citation;

use Pod::Usage;
use Pod::Text;


if (@ARGV == 0) {
  pod2usage();
}

my @searchterms=();

while (my $opt = shift @ARGV) {
  if ($opt eq '-u' || $opt eq '-h' || $opt eq '--help') {
    pod2text($0);
    exit 0;
  }

  push @searchterms, $opt;  
}

my $term = join('+OR+', @searchterms);
my $def_query = {'term' => $term,
		 'db'   => 'taxonomy',
		 'rettype' => 'xml'};




my $res = pm_query($def_query);
if (! defined $res) {
  print STDERR "An error occured. Please correct your search terms or try again later.\n";
  exit 1;
}

my @strarray = split(/\s+/, $res);
my @ids = ();
while (scalar(@strarray) > 0 && $strarray[0] ne '<IdList>') {
  shift @strarray;
  ;
}
my $cur_id=undef;
foreach my $s (@strarray) {
  if ($s =~  m/<Id>(\d+)<\/Id>/g) {	# Found a new current id
    push @ids, $1;
  }  elsif ($s =~ m/<\/IdList>/) {
    # If end marker of a 'link' is found, break out
    @strarray = ();
  }
}  

my $fetch_params = {'db' => 'taxonomy',
		    'rettype' => 'xml',
		    'retmode' => 'xml',
		    'id' => \@ids};
$res = pm_fetch($fetch_params);

#print STDERR "RES: $$res\n";
my $ignore_detailed_lineage_nodes = 0;
if (defined $$res && length($$res) > 0) {
  @strarray = split("\n", $$res);
  foreach my $s (@strarray) {
    if ($s =~ m/<ScientificName>(.+)<\/ScientificName>/) {
      if ($ignore_detailed_lineage_nodes) {
	next;
      } else {
	print "Scientific Name: $1\n";
      }
    } elsif ($s =~ m/CommonName>(.+)<\/\S*CommonName>/) { # GenbankCommonName or CommonName
      print "    Common Name: $1\n";
    } elsif ($s =~ m/<Rank>(.+)<\/Rank>/) {
      if ($ignore_detailed_lineage_nodes) {
	next;
      } else {
	if ($1 ne 'no rank') {
	  print "           Rank: $1\n";
	}
      }
    } elsif ($s =~ m/<Division>(.+)<\/Division>/) {
      print "       Division: $1\n";
    } elsif ($s =~ m/<Lineage>(.+)<\/Lineage>/) {
      print "        Lineage: $1\n";
    } elsif ($s =~ m/<LineageEx>/) {
      $ignore_detailed_lineage_nodes = 1;
    } elsif ($s =~ m/<\/LineageEx>/) {
      $ignore_detailed_lineage_nodes = 0;
    } elsif ($s =~ m/<\/Taxon>/) {
      if ($ignore_detailed_lineage_nodes) {
	next;
      } else {
	print "\n";
      }
    }
  }
}
exit 0;
